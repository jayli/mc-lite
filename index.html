<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>Web Minecraft: Refactored</title>
    <link data-n-head="ssr" rel="icon" type="image/x-icon" href="./src/style/icon.png" />
    <link rel="stylesheet" href="./src/style/global.css" />
  </head>
  <body>
    <div id="crosshair"></div>
    <div id="hud">
      <b>Minecraft - blooming</b><br>
      <b>繁花与沼泽，空岛与森林</b> | Author by jayli<br>
      <b>群系: </b>杜鹃林(苔藓/花树), 沼泽(藤蔓/睡莲)，森林，沙漠，草地<br>
      <b>操作：</b><br>
      WASD（↑↓←→）: 移动 | Z: 背包 | Esc/Z: 关闭背包<br>
      Ctrl+左键: 点燃 tnt 炸药 | R: 换枪<br>
      I: 关闭/打开信息看板 | M: 地图审计 | P: 开启性能监控<br>
      鼠标左键: 挖掘 | 鼠标右键: <b>放置方块/互动</b>
      <div id="perf"></div>
      <div id="msg"></div>
    </div>
    <div id="hotbar"></div>
    <div id="settings-btn">⚙</div>

    <!-- 启动存档提示模态框 -->
    <div id="load-save-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center; flex-direction:column; color:white;">
      <div style="background:#c6c6c6; border:4px solid #555; padding:30px; border-radius:4px; box-shadow:5px 5px 0 #000; text-align:center; color:#333; width:400px;">
        <h2 style="margin-top:0;">发现现有存档</h2>
        <p>检测到您之前手动保存的游戏进度，请选择：</p>
        <div style="display:flex; gap:15px; margin-top:25px; justify-content:center;">
          <button id="btn-load-save" style="background:#559944; flex:1;">加载存档</button>
          <button id="btn-new-world" style="background:#8b8b8b; flex:1;">开启新世界</button>
        </div>
      </div>
    </div>

    <div id="settings-modal">
      <div id="settings-content">
        <h2 style="margin-top:0; text-align:left;">游戏设置</h2>
        <div class="setting-item">
          <span style="text-align:left;">渲染画质:</span>
          <div class="btn-group">
            <button id="btn-perf">性能 (0.4x)</button>
            <button id="btn-mid">平衡 (0.7x)</button>
            <button id="btn-quality">画质 (1.0x)</button>
          </div>
        </div>
        <!-- 存档功能按钮 -->
        <div class="setting-item" style="margin-top:15px; border-top:1px solid #999; padding-top:15px;">
          <span style="text-align:left;">游戏存档:</span>
          <button id="btn-save-game" style="width:100%; margin-top:5px; background:#4a90e2;">保存当前进度 (存档)</button>
        </div>
        <div style="margin-top: auto; display: flex; justify-content: center; padding-top:20px;">
          <button id="settings-close">确定</button>
        </div>
      </div>
    </div>

    <div id="inventory-modal">
      <div id="inventory-content">
        <h2 style="margin:0">物品清单 (点击装备)</h2>
        <div id="inventory-grid"></div>
      </div>
    </div>

    <script type="importmap">
       {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "stats": "https://unpkg.com/three@0.160.0/examples/jsm/libs/stats.module.js"
            }
        }
    </script>

    <script type="module">
import { Game } from './src/core/Game.js';
        import { initializeMaterials } from './src/core/materials/MaterialManager.js';
        import { initializeAudio } from './src/core/AudioManager.js';
        import { manualSaveService } from './src/services/ManualSaveService.js';
        import { setSeed } from './src/utils/MathUtils.js';

        async function main() {
            await Promise.all([
                initializeMaterials(),
                initializeAudio()
            ]);

            const hasSave = await manualSaveService.checkSaveExists();
            const modal = document.getElementById('load-save-modal');

            if (hasSave && modal) {
              modal.style.display = 'flex';

              const loadBtn = document.getElementById('btn-load-save');
              const newBtn = document.getElementById('btn-new-world');

              const startGame = async (saveData = null) => {
                modal.style.display = 'none';

                // 如果是加载存档，在创建 Game 实例前恢复种子
                if (saveData && saveData.seed !== undefined) {
                  console.log(`[Main] Restoring seed from save: ${saveData.seed}`);
                  setSeed(saveData.seed);
                } else if (saveData) {
                  console.warn('[Main] Loading save but no seed found in saveData');
                }

                const game = new Game();
                if (saveData) {
                  await game.applySaveData(saveData);
                }
                game.start();
                window.game = game;
              };

              loadBtn.onclick = async () => {
                const saveData = await manualSaveService.load();
                startGame(saveData);
              };

              newBtn.onclick = () => {
                startGame(null);
              };
            } else {
              const game = new Game();
              game.start();
              window.game = game; // Expose for debugging
            }
        }

        main();
    </script>
  </body>
</html>
